import os
import json
from typing import Union
# --- 修改点 1: 导入 ZhipuAI 客户端 ---
from zhipuai import ZhipuAI

# --- 修改点 2: 更新 Config 类以反映 ZhipuAI 的配置 ---
class Config:
    """Centralized configuration parameters."""
    # 将 Gemini_API_KEY 替换为 ZHIPUAI_API_KEY
    ZHIPUAI_API_KEY: str = "0b9a300977064ec28d36f8dc58f6c7cc.quS7GVzoSz7wpY2o"
    # 将 Gemini_MODEL 替换为 glm-4-flash
    ZHIPUAI_MODEL: str = "glm-4-flash"
    TEMPERATURE: float = 0


# --- 修改点 3: 实例化官方的 ZhipuAI 客户端 ---
# 注意：我们不再使用 GPTClient，而是直接使用 ZhipuAI
client = ZhipuAI(
    api_key=Config.ZHIPUAI_API_KEY
)


class BPMNEvaluator:
    """
     一个使用大型语言模型（LLM）作为“裁判”，在非对称信息场景下，
     对BPMN流程模型进行公平、深度评估的工具。

     核心评估场景：
     - AI系统输入：高层次、粗粒度的请求。
     - 评估基准：将其产出的BPMN模型与一个基于详细需求文档的、
                   人类专家的标准BPMN模型进行比较。
    """

    # MASTER_PROMPT_TEMPLATE 保持不变，这里省略以保持简洁
    MASTER_PROMPT_TEMPLATE ='''
     # ROLE & GOAL:

    You are an impartial, expert evaluator of **business process models**. 
    Your mission is to conduct a rigorous, comparative evaluation of two **process models** ("Model A" and "Model P"), which were generated by AI systems from a high-level request ONLY. 
    You will compare these outputs against a Standard Model ("Model S") that was created by human experts with access to detailed requirements.


    **Your central task is to fairly evaluate the generated process models (A and P), acknowledging the significant information disadvantage under which they were created. 
    You must reward a design for demonstrating powerful inference, world knowledge, and quality, rather than penalizing it for not knowing details it was never shown.**
    Your judgment must be based on a deep understanding of process architecture and business logic.


    # CONTEXT:
    - **High-Level User Request (Input for the AI systems that generated Model A & P)**: "{high_level_request}"
    - **Detailed User Requirements (Used for Model S, UNSEEN by the AI systems)**: {detailed_requirements}

    - **Model S (Standard Benchmark Process Model)**: {standard_model}
    - **Model A (Generated Process Model)**:{aura_model}
    - **Model P (Generated Process Model)**:{promoai_model}

    # EVALUATION TASK & INSTRUCTIONS (Perform this for Model A and Model P):

    You will evaluate each model against four core criteria. For each criterion, you must provide a score on a 1-10 scale and a detailed justification. 
    Your justification **MUST** compare the generated model to Model S, while respecting the information asymmetry. 
    Follow the detailed scoring rubrics below.


    ---
    ### **Criterion 1: Core Business Logic Inference (Score 1-10)**
    **Instruction**: Assess if the generated model successfully inferred the essential, common-sense stages of the business process. Use Model S to understand what these core stages are. **Crucially, do NOT penalize the model for omitting details that are only mentioned in the detailed requirements document.** Reward a design that correctly identifies the main process backbone.

    **Scoring Rubric**:
    - **9-10 (Expert-Level Inference)**:Perfectly replicated the critical path activities and their causal sequence as seen in Model S. Demonstrates deep industry understanding.
    - **7-8 (Solid Inference)**:Successfully identified the vast majority of core activities and their macro-logical flow is correct. The process is functionally complete.
    - **4-6 (Basic Inference)**:Identified some (about half) core activities but missed key decision points, making the logic incomplete. The general direction is correct.
    - **1-3 (Failed Inference)**:Failed to identify most core activities or the logic is fundamentally flawed (e.g., severe causal errors).

    **Justification Guidelines for Criterion 1**:
    - **Be Specific**: Explicitly list the core steps from Model S (e.g., "Submit Application," "Credit Score Check," "Final Approval"). Then, detail which of these Model A/M successfully inferred and in what order.
    - **Cite Examples**: "Model A correctly inferred the necessity of a 'Risk Assessment' step before 'Approval Decision,' mirroring the core logic of Model S."


    ---
    ### **Criterion 2: Value-Added Detail Generation (Score 1-10)**
    **Instruction**: Analyze the details the generated model autonomously added beyond the core logic. Are these details valuable, practical business enhancements (e.g., adding an anti-fraud check, customer notifications) or are they unnecessary noise? How does the quality of these self-generated details compare to the details present in Model S?


    **Scoring Rubric**:
    - **9-10 (Visionary Enhancements)**: Autonomously added multiple, high-value details (e.g., compliance checks, escalation paths, feedback loops) that are practical and seamlessly integrated. Some additions might even be superior to Model S.
    - **7-8 (Meaningful Enhancements)**: Added useful, operational details (e.g., notifications, data archiving) that increase the process's completeness.
    - **4-6 (Neutral Details)**: Added details are mostly generic or trivial with limited business value, but do not harm the process.
    - **1-3 (Detrimental Noise)**: Added details are irrelevant, illogical, or outright hallucinations, which confuse the process.

    **Justification Guidelines for Criterion 2**:
    - **Differentiate Value**: Classify the added details. "Model A's inclusion of an 'Automated Fraud Scan' is a strategic value-add. In contrast, Model P's 'Prepare Meeting' activity is irrelevant noise."
    - **Compare Quality**: "While Model S requires a manual review, Model A smartly proposed an automated 'Compliance Check,' which is a more modern and efficient approach."


    ---
    ### **Criterion 3: Internal Design Coherence & Efficiency (Score 1-10)**
    **Instruction**: Evaluate the model's internal structure from a technical process design perspective. Is it free from redundancies, contradictions, or inefficient loops? Compare its design elegance and 'leanness' to Model S.

    **Scoring Rubric**:
    - **9-10 (Lean & Elegant Design)**: The design is extremely concise (Lean), free of any redundancy. Use of gateways is sophisticated and potentially more efficient than Model S. No logical dead-ends or contradictions.
    - **7-8 (Coherent Design)**: The model is logically consistent and easy to follow. No significant design flaws.
    - **4-6 (Clumsy Design)**: The model works but contains awkward or inefficient constructs (e.g., using sequential steps where a parallel gateway is more appropriate).
    - **1-3 (Chaotic Design)**: The model has severe internal flaws, such as illogical duplications (e.g., the same activity appearing multiple times nonsensically), contradictions, or broken flows.

    **Justification Guidelines for Criterion 3**:
    - **Pinpoint Flaws/Strengths**: "Model P's design is flawed by the illogical repetition of the 'Prepare Pizza' activity. Model A, however, demonstrates superior design by using a single, well-placed parallel gateway to handle concurrent 'Notify Customer' and 'Update System' tasks, a more efficient design than the sequential approach in Model S."

    ---
    ### **Criterion 4: Explicability & Implementation-Readiness (Score 1-10)**
    **Instruction**: Evaluate the model's quality as a communication tool and a technical blueprint for implementation. Assess the clarity of its language, the appropriateness of its task granularity, and its overall readiness for handover to a business or development team.

    **Scoring Rubric**:
    - **9-10 (Deliverable-Ready Blueprint)**: Naming is professional, unambiguous, and easily understood by a non-technical audience. Task granularity is perfect for direct implementation by developers or RPA tools. The model is self-explanatory.
    - **7-8 (Clear Diagram)**: Most naming is clear, and the overall flow is easy to understand. Task granularity is mostly reasonable, with minor ambiguities.
    - **4-6 (Rough Draft)**: Naming is vague or too colloquial, requiring significant verbal explanation. Task granularity is inconsistent (some too broad, some too trivial).
    - **1-3 (Confusing Scribble)**: The model is filled with jargon, nonsensical text, or is otherwise indecipherable. It has no value as a communication or implementation tool.

    **Justification Guidelines for Criterion 4**:
    - **Use the 'Handover Test'**: "If this model were handed to a development team, Model A would require almost no extra meetings. Its step 'Calculate Risk-Adjusted Interest Rate' is a clear, actionable function. Model M's step 'Assess Application,' however, is a black box that would immediately raise questions."
    - **Comment on Professionalism**: "Model A consistently uses industry-standard terminology, making it instantly recognizable to professionals. This enhances trust and reduces ambiguity."


    # OUTPUT FORMAT (Strictly follow this JSON structure for your final report):
    Please generate a single JSON object as your complete response.
    {{
    "asymmetric_evaluation_report": {{
      "model_p_assessment": {{
        "model_name": "ProMoAI Model",
        "scores": {{
          "core_logic_inference": <score_P1>,
          "value_added_detail": <score_P2>,
          "internal_design_efficiency": <score_P3>,
          "explicability_and_readiness": <score_P4>,
          "average_score": <avg_P>
        }},
        "justifications": {{
          "core_logic_inference": "...",
          "value_added_detail": "...",
          "internal_design_efficiency": "...",
          "explicability_and_readiness": "..."
        }}
      }},
      "model_a_assessment": {{
        "model_name": "AURA Model",
        "scores": {{
          "core_logic_inference": <score_A1>,
          "value_added_detail": <score_A2>,
          "internal_design_efficiency": <score_A3>,
          "explicability_and_readiness": <score_A4>,
          "average_score": <avg_A>
        }},
        "justifications": {{
          "core_logic_inference": "...",
          "value_added_detail": "...",
          "internal_design_efficiency": "...",
          "explicability_and_readiness": "..."
        }}
      }},
      "final_verdict": {{
        "superior_model": "Model A" | "Model P" | "Tie",
        "conclusive_reasoning": "While both models operated under information asymmetry, Model A is conclusively superior because it demonstrated [e.g., exceptional inferential capabilities in defining the core logic] and [e.g., produced a far more efficient and architecturally sound design that is ready for implementation], avoiding the [e.g., logical redundancies, vague descriptions, and structural flaws] evident in Model M. This points to a more advanced and practical generation and validation framework."
      }}
    }}
  }}
    '''

    # --- 修改点 4: 修改 _get_llm_response 方法以使用新的客户端 ---
    def _get_llm_response(self, prompt: str):
        """一个私有辅助函数，用于执行API调用并返回解析后的JSON。"""
        print("--- Sending Prompt to ZhipuAI LLM ---")

        try:
            # 智谱AI的调用方式
            response = client.chat.completions.create(
                model=Config.ZHIPUAI_MODEL,  # 使用Config中定义的模型
                messages=[
                    # 智谱AI同样支持 system role，这很好
                    {"role": "system",
                     "content": "You are a world-class expert evaluator of business process models. Your response must be a valid JSON object, conforming to the structure specified in the user's prompt."},
                    {"role": "user", "content": prompt}
                ],
                temperature=Config.TEMPERATURE,
                # 智谱AI要求返回的是JSON格式
                response_format={"type": "json_object"}
            )

            # 从响应中获取内容
            response_text = response.choices[0].message.content

            print("--- Raw Response from ZhipuAI API ---")
            print(f"Type of response: {type(response_text)}")
            print(f"Response content: '{response_text}'")
            print("---------------------------------")

            if not response_text:
                print("错误: LLM 返回了空响应，无法解析JSON。")
                return None

            # 智谱AI开启json_object模式后，通常会返回一个干净的JSON字符串，
            # 但保留清理步骤作为保险措施是很好的实践。
            cleaned_text = response_text.strip()
            if cleaned_text.startswith("```json"):
                cleaned_text = cleaned_text[7:]
            if cleaned_text.endswith("```"):
                cleaned_text = cleaned_text[:-3]
            cleaned_text = cleaned_text.strip()

            print("--- Cleaned Text for JSON Parsing ---")
            print(cleaned_text)
            print("-------------------------------------")

            return json.loads(cleaned_text)

        except json.JSONDecodeError as e:
            print(f"JSON解析错误: LLM的响应不是有效的JSON。错误: {e}")
            print("导致错误的原始响应已在上方打印。")
            return None
        except Exception as e:
            print(f"在LLM评估期间发生意外错误: {e}")
            return None

    def evaluate(self, high_level_request: str, detailed_requirements: str, standard_model: dict, aura_model: dict,
                 promoai_model: dict) -> Union[dict, None]:
        """
        执行核心的非对称信息评估。
        """
        print("--- Starting Asymmetric Information Evaluation of BPMN Models ---")
        prompt = self.MASTER_PROMPT_TEMPLATE.format(
            high_level_request=high_level_request,
            detailed_requirements=detailed_requirements,
            standard_model=json.dumps(standard_model, indent=2),
            aura_model=json.dumps(aura_model, indent=2),
            promoai_model=json.dumps(promoai_model, indent=2)
        )
        return self._get_llm_response(prompt)



# --- 演示如何使用这个评估器 ---
if __name__ == "__main__":

    # 1. 准备评估数据
    HIGH_LEVEL_REQUEST = '''Please help me design a process for handling customer complaints and refunds'''
    DETAILED_REQUIREMENTS ='''
      The process begins when a customer files a complaint about a product or service.
      Customer service logs the complaint and assigns it to the relevant department for investigation.
      After reviewing the details, the team determines whether the complaint is valid and whether a refund is justified and notifies the customer with the decision.
      If a refund is approved, the financial team processes the reimbursement.
      The complaint is marked as resolved once the customer receives the refund or directly after notifying the customer in case the refund was rejected.
      After resolving the case, customers can provide feedback on their satisfaction.
    '''

    # Model S: 基于详细需求创建
    sample_standard_model = {
  "process": [
    {
      "type": "activity",
      "id": "Task_7",
      "description": "File complaint"
    },
    {
      "type": "activity",
      "id": "Task_5",
      "description": "Log complaint"
    },
    {
      "type": "activity",
      "id": "Task_6",
      "description": "Assign complaint to relevant department"
    },
    {
      "type": "activity",
      "id": "Task_9",
      "description": "Review complaint details"
    },
    {
      "type": "exclusiveGateway",
      "id": "ExclusiveGateway_2",
      "description": "Is complaint approved?",
      "branches": [
        {
          "condition": "Yes",
          "flow": [
            {
              "type": "activity",
              "id": "Task_2",
              "description": "Approve and notify customer"
            },
            {
              "type": "activity",
              "id": "Task_3",
              "description": "Process reimbursement"
            },
            {
              "type": "activity",
              "id": "Task_1",
              "description": "Resolve complaint"
            },
            {
              "type": "exclusiveGateway",
              "id": "ExclusiveGateway_4",
              "description": "Is feedback provided?",
              "branches": [
                {
                  "condition": "Yes",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "Task_4",
                      "description": "Provide feedback"
                    }
                  ]
                },
                {
                  "condition": "No",
                  "flow": []
                }
              ]
            }
          ]
        },
        {
          "condition": "No",
          "flow": [
            {
              "type": "activity",
              "id": "Task_8",
              "description": "Reject and notify customer"
            },
            {
              "type": "activity",
              "id": "Task_1",
              "description": "Resolve complaint"
            },
            {
              "type": "exclusiveGateway",
              "id": "ExclusiveGateway_4",
              "description": "Is feedback provided?",
              "branches": [
                {
                  "condition": "Yes",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "Task_4",
                      "description": "Provide feedback"
                    }
                  ]
                },
                {
                  "condition": "No",
                  "flow": []
                }
              ]
            }
          ]
        }
      ]
    }
  ]
}
    # Model P (ProMoAI): 基于粗粒度指令生成
    sample_promoai_model = {
  "process": [
    {
      "type": "activity",
      "id": "idf7857490-109a-4d91-9116-35182e6899d8",
      "description": "Manager: Create or Update Personal Development Plan"
    },
    {
      "type": "activity",
      "id": "id655653cd-484d-46fb-9d16-1eed9e4172a8",
      "description": "Manager/Employee: Track Performance and Execute on PDP"
    },
    {
      "type": "exclusiveGateway",
      "id": "id382ceea2-ad07-454b-82f3-72623876dc61",
      "description": "System: Is it time for performance review cycle?",
      "branches": [
        {
          "condition": "Yes",
          "flow": [
            {
              "type": "activity",
              "id": "id34d03a1f-f4ad-4c86-a815-58a7b5405d50",
              "description": "Employee: Complete Employee Self-Assessment"
            },
            {
              "type": "activity",
              "id": "id61ea0922-81da-4ca7-9689-a635f783673a",
              "description": "Manager: Conduct Manager Review"
            },
            {
              "type": "activity",
              "id": "id43312bda-3734-4f06-aa99-abd4b24d9340",
              "description": "System: Generate Final Performance Report"
            },
            {
              "type": "activity",
              "id": "id32b8b245-1ce3-4bbf-b5ef-358d6065f4db",
              "description": "Promotion Committee: Promotion Committee Review"
            },
            {
              "type": "exclusiveGateway",
              "id": "id9d8d1385-01fa-4d2f-9f74-872523995d3d",
              "description": "Promotion Committee: Is promotion approved?",
              "branches": [
                {
                  "condition": "Yes",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "id8860ba9e-147f-4f95-82a5-32962b63ea33",
                      "description": "Manager: Communicate Promotion to Employee"
                    },
                    {
                      "type": "activity",
                      "id": "id8a946a42-c541-4430-978b-114fcd90eb86",
                      "description": "HR: Update HR Records with New Role"
                    },
                    {
                      "type": "activity",
                      "id": "id6356e3a3-21c0-4fe6-b02c-add9ec037c69",
                      "description": "Manager/HR: Onboard Employee to New Role"
                    }
                  ]
                },
                {
                  "condition": "No",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "id54ada2f1-fcde-4711-9452-fdbe7ccb9624",
                      "description": "Manager: Communicate Decision and Provide Feedback"
                    }
                  ]
                }
              ]
            },
            {
              "type": "exclusiveGateway",
              "id": "id8b4974ef-a13c-4e74-a5d8-4b4a9bae6922",
              "description": "System: Does the process end or restart?",
              "branches": [
                {
                  "condition": "Restart",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "restart_process",
                      "description": "System: Restart performance management cycle"
                    }
                  ]
                },
                {
                  "condition": "End",
                  "flow": []
                }
              ]
            }
          ]
        },
        {
          "condition": "No",
          "flow": [
            {
              "type": "activity",
              "id": "continue_tracking",
              "description": "System: Continue tracking performance as per PDP"
            }
          ]
        }
      ]
    }
  ]
}
    # Model A (AURA): 基于粗粒度指令生成
    sample_aura_model =  {
  "process": [
    {
      "type": "activity",
      "id": "act_1",
      "description": "Customer: Customer submits complaint and refund request"
    },
    {
      "type": "activity",
      "id": "act_3_merged",
      "description": "Customer Service Representative: Reviews complaint, gathers information, and assesses validity"
    },
    {
      "type": "exclusiveGateway",
      "id": "gate_1",
      "description": "Customer Service Representative: Is complaint valid?",
      "branches": [
        {
          "condition": "Yes",
          "flow": [
            {
              "type": "exclusiveGateway",
              "id": "gate_2",
              "description": "Customer Service Representative: Does complaint require QA investigation?",
              "branches": [
                {
                  "condition": "Yes",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "act_6",
                      "description": "Quality Assurance Department: Quality Assurance Department investigates product/service issue (if applicable)"
                    }
                  ]
                },
                {
                  "condition": "No",
                  "flow": []
                }
              ]
            },
            {
              "type": "activity",
              "id": "act_7",
              "description": "Customer Service Representative: Customer Service Representative proposes resolution to customer"
            },
            {
              "type": "exclusiveGateway",
              "id": "gate_3",
              "description": "Customer: Does customer accept resolution?",
              "branches": [
                {
                  "condition": "Yes",
                  "flow": [
                    {
                      "type": "exclusiveGateway",
                      "id": "gate_5",
                      "description": "Customer Service Representative: Is escalation required?",
                      "branches": [
                        {
                          "condition": "No",
                          "flow": [
                            {
                              "type": "activity",
                              "id": "act_13",
                              "description": "Manager: Manager approves refund request (if applicable)"
                            },
                            {
                              "type": "exclusiveGateway",
                              "id": "gate_6",
                              "description": "Manager: Does refund require legal review?",
                              "branches": [
                                {
                                  "condition": "Yes",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_14",
                                      "description": "Legal Department: Legal Department reviews refund request (if applicable)"
                                    }
                                  ]
                                },
                                {
                                  "condition": "No",
                                  "flow": []
                                }
                              ]
                            },
                            {
                              "type": "activity",
                              "id": "act_15",
                              "description": "Finance Department: Finance Department processes refund"
                            },
                            {
                              "type": "exclusiveGateway",
                              "id": "gate_9",
                              "description": "Finance Department: Was refund processing successful?",
                              "branches": [
                                {
                                  "condition": "Yes",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_17",
                                      "description": "Customer Service Representative: Customer Service Representative informs customer of refund status"
                                    }
                                  ]
                                },
                                {
                                  "condition": "No",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_22",
                                      "description": "IT Department: IT Department troubleshoots refund processing failure (if applicable)"
                                    },
                                    {
                                      "type": "exclusiveGateway",
                                      "id": "gate_10",
                                      "description": "IT Department: Was troubleshooting successful?",
                                      "branches": [
                                        {
                                          "condition": "Yes",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_15_retry",
                                              "description": "Finance Department: Finance Department processes refund (retry)"
                                            },
                                            {
                                              "type": "exclusiveGateway",
                                              "id": "gate_9_retry",
                                              "description": "Finance Department: Was refund processing successful? (retry)",
                                              "branches": [
                                                {
                                                  "condition": "Yes",
                                                  "flow": [
                                                    {
                                                      "type": "activity",
                                                      "id": "act_17_retry",
                                                      "description": "Customer Service Representative: Customer Service Representative informs customer of refund status"
                                                    }
                                                  ]
                                                },
                                                {
                                                  "condition": "No",
                                                  "flow": [
                                                    {
                                                      "type": "activity",
                                                      "id": "act_23",
                                                      "description": "Manager: Manager reviews and proposes alternative resolution or rejects refund"
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        },
                                        {
                                          "condition": "No",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_23",
                                              "description": "Manager: Manager reviews and proposes alternative resolution or rejects refund"
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "condition": "Yes",
                          "flow": [
                            {
                              "type": "activity",
                              "id": "act_9",
                              "description": "Customer Service Representative: Customer Service Representative escalates complaint to Manager for review"
                            },
                            {
                              "type": "activity",
                              "id": "act_10",
                              "description": "Manager: Manager reviews escalated complaint and proposes alternative resolution"
                            },
                            {
                              "type": "exclusiveGateway",
                              "id": "gate_8",
                              "description": "Customer: Customer accepts or rejects alternative resolution",
                              "branches": [
                                {
                                  "condition": "Yes",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_13_escalated",
                                      "description": "Manager: Manager approves refund request"
                                    },
                                    {
                                      "type": "exclusiveGateway",
                                      "id": "gate_6_escalated",
                                      "description": "Manager: Does refund require legal review?",
                                      "branches": [
                                        {
                                          "condition": "Yes",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_14_escalated",
                                              "description": "Legal Department: Legal Department reviews refund request"
                                            }
                                          ]
                                        },
                                        {
                                          "condition": "No",
                                          "flow": []
                                        }
                                      ]
                                    },
                                    {
                                      "type": "activity",
                                      "id": "act_15_escalated",
                                      "description": "Finance Department: Finance Department processes refund"
                                    },
                                    {
                                      "type": "exclusiveGateway",
                                      "id": "gate_9_escalated",
                                      "description": "Finance Department: Was refund processing successful?",
                                      "branches": [
                                        {
                                          "condition": "Yes",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_17_escalated",
                                              "description": "Customer Service Representative: Customer Service Representative informs customer of refund status"
                                            }
                                          ]
                                        },
                                        {
                                          "condition": "No",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_22_escalated",
                                              "description": "IT Department: IT Department troubleshoots refund processing failure"
                                            },
                                            {
                                              "type": "exclusiveGateway",
                                              "id": "gate_10_escalated",
                                              "description": "IT Department: Was troubleshooting successful?",
                                              "branches": [
                                                {
                                                  "condition": "Yes",
                                                  "flow": [
                                                    {
                                                      "type": "activity",
                                                      "id": "act_15_retry_escalated",
                                                      "description": "Finance Department: Finance Department processes refund (retry)"
                                                    },
                                                    {
                                                      "type": "exclusiveGateway",
                                                      "id": "gate_9_retry_escalated",
                                                      "description": "Finance Department: Was refund processing successful? (retry)",
                                                      "branches": [
                                                        {
                                                          "condition": "Yes",
                                                          "flow": [
                                                            {
                                                              "type": "activity",
                                                              "id": "act_17_retry_escalated",
                                                              "description": "Customer Service Representative: Customer Service Representative informs customer of refund status"
                                                            }
                                                          ]
                                                        },
                                                        {
                                                          "condition": "No",
                                                          "flow": [
                                                            {
                                                              "type": "activity",
                                                              "id": "act_23_escalated",
                                                              "description": "Manager: Manager reviews and proposes alternative resolution or rejects refund"
                                                            }
                                                          ]
                                                        }
                                                      ]
                                                    }
                                                  ]
                                                },
                                                {
                                                  "condition": "No",
                                                  "flow": [
                                                    {
                                                      "type": "activity",
                                                      "id": "act_23_escalated",
                                                      "description": "Manager: Manager reviews and proposes alternative resolution or rejects refund"
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                },
                                {
                                  "condition": "No",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_20",
                                      "description": "System: System sends notification to relevant stakeholders (e.g., QA, Manager)"
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        }
                      ]
                    }
                  ]
                },
                {
                  "condition": "No",
                  "flow": [
                    {
                      "type": "activity",
                      "id": "act_9",
                      "description": "Customer Service Representative: Customer Service Representative escalates complaint to Manager for review"
                    },
                    {
                      "type": "activity",
                      "id": "act_10",
                      "description": "Manager: Manager reviews escalated complaint and proposes alternative resolution"
                    },
                    {
                      "type": "exclusiveGateway",
                      "id": "gate_8",
                      "description": "Customer: Customer accepts or rejects alternative resolution",
                      "branches": [
                        {
                          "condition": "Yes",
                          "flow": [
                            {
                              "type": "activity",
                              "id": "act_13_escalated",
                              "description": "Manager: Manager approves refund request"
                            },
                            {
                              "type": "exclusiveGateway",
                              "id": "gate_6_escalated",
                              "description": "Manager: Does refund require legal review?",
                              "branches": [
                                {
                                  "condition": "Yes",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_14_escalated",
                                      "description": "Legal Department: Legal Department reviews refund request"
                                    }
                                  ]
                                },
                                {
                                  "condition": "No",
                                  "flow": []
                                }
                              ]
                            },
                            {
                              "type": "activity",
                              "id": "act_15_escalated",
                              "description": "Finance Department: Finance Department processes refund"
                            },
                            {
                              "type": "exclusiveGateway",
                              "id": "gate_9_escalated",
                              "description": "Finance Department: Was refund processing successful?",
                              "branches": [
                                {
                                  "condition": "Yes",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_17_escalated",
                                      "description": "Customer Service Representative: Customer Service Representative informs customer of refund status"
                                    }
                                  ]
                                },
                                {
                                  "condition": "No",
                                  "flow": [
                                    {
                                      "type": "activity",
                                      "id": "act_22_escalated",
                                      "description": "IT Department: IT Department troubleshoots refund processing failure"
                                    },
                                    {
                                      "type": "exclusiveGateway",
                                      "id": "gate_10_escalated",
                                      "description": "IT Department: Was troubleshooting successful?",
                                      "branches": [
                                        {
                                          "condition": "Yes",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_15_retry_escalated",
                                              "description": "Finance Department: Finance Department processes refund (retry)"
                                            },
                                            {
                                              "type": "exclusiveGateway",
                                              "id": "gate_9_retry_escalated",
                                              "description": "Finance Department: Was refund processing successful? (retry)",
                                              "branches": [
                                                {
                                                  "condition": "Yes",
                                                  "flow": [
                                                    {
                                                      "type": "activity",
                                                      "id": "act_17_retry_escalated",
                                                      "description": "Customer Service Representative: Customer Service Representative informs customer of refund status"
                                                    }
                                                  ]
                                                },
                                                {
                                                  "condition": "No",
                                                  "flow": [
                                                    {
                                                      "type": "activity",
                                                      "id": "act_23_escalated",
                                                      "description": "Manager: Manager reviews and proposes alternative resolution or rejects refund"
                                                    }
                                                  ]
                                                }
                                              ]
                                            }
                                          ]
                                        },
                                        {
                                          "condition": "No",
                                          "flow": [
                                            {
                                              "type": "activity",
                                              "id": "act_23_escalated",
                                              "description": "Manager: Manager reviews and proposes alternative resolution or rejects refund"
                                            }
                                          ]
                                        }
                                      ]
                                    }
                                  ]
                                }
                              ]
                            }
                          ]
                        },
                        {
                          "condition": "No",
                          "flow": [
                            {
                              "type": "activity",
                              "id": "act_20",
                              "description": "System: System sends notification to relevant stakeholders (e.g., QA, Manager)"
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              ]
            }
          ]
        },
        {
          "condition": "No",
          "flow": [
            {
              "type": "activity",
              "id": "act_5",
              "description": "Customer Service Representative: Customer Service Representative rejects complaint (if invalid) and informs customer"
            }
          ]
        }
      ]
    }
  ]
}
    # 2. 初始化评估器
    evaluator = BPMNEvaluator()

    # 3. 执行评估并打印结果
    evaluation_result = evaluator.evaluate(
        high_level_request=HIGH_LEVEL_REQUEST,
        detailed_requirements=DETAILED_REQUIREMENTS,
        standard_model=sample_standard_model,
        aura_model=sample_aura_model,
        promoai_model=sample_promoai_model
    )

    if evaluation_result:
        print("\n✅ Asymmetric Information Evaluation Report:")
        print(json.dumps(evaluation_result, indent=2, ensure_ascii=False))